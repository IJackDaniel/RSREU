.386
.model flat, stdcall
option casemap:none

; ????????? ??? ???????
IDD_DIALOG equ 500

; ??????????? ??????????? ?????????
include \masm32\include\windows.inc
include \masm32\include\user32.inc
include \masm32\include\kernel32.inc
include \masm32\include\gdi32.inc
include \masm32\include\msvcrt.inc

includelib \masm32\lib\user32.lib
includelib \masm32\lib\kernel32.lib
includelib \masm32\lib\gdi32.lib
includelib \masm32\lib\msvcrt.lib

; ????????? ???????
DialogProc PROTO :DWORD, :DWORD, :DWORD, :DWORD
InitDialog PROTO :DWORD, :DWORD, :DWORD
CommandHandler PROTO :DWORD, :DWORD, :DWORD, :DWORD
PaintHandler PROTO :DWORD

; ?????????
IDCANCEL equ 2
WM_INITDIALOG equ 110h
WM_COMMAND equ 111h
WM_PAINT equ 0Fh
PS_SOLID equ 0

.data
    hRedPen dd 0                ; ?????????? ??????? ?????
    PI real8 3.141592653589793  ; ????? ??
    step real8 0.01             ; ??? ??? ?????????? ??????
    scale real8 15.0            ; ??????? ??????
    two real8 2.0               ; ????????? 2
    three real8 3.0             ; ????????? 3
    oneHalf real8 1.5           ; ????????? 1.5
    centerX dd 100              ; ????? ????????? ?? X
    centerY dd 70               ; ????? ????????? ?? Y

.code

start:
    ; ?????? ???? ? ????????
    invoke GetModuleHandle, NULL
    invoke DialogBoxParam, eax, IDD_DIALOG, NULL, addr DialogProc, NULL
    invoke ExitProcess, 0

; ??????? ????????? ????????? ????????? ???????
DialogProc proc hWnd:DWORD, uMsg:DWORD, wParam:DWORD, lParam:DWORD
    
    .if uMsg == WM_INITDIALOG
        invoke InitDialog, hWnd, wParam, lParam
        mov eax, 1
        ret
    .elseif uMsg == WM_COMMAND
        invoke CommandHandler, hWnd, wParam, lParam, 0
        mov eax, 1
        ret
    .elseif uMsg == WM_PAINT
        invoke PaintHandler, hWnd
        mov eax, 1
        ret
    .else
        mov eax, 0
        ret
    .endif
    
DialogProc endp

; ????????????? ??????????? ????
InitDialog proc hWnd:DWORD, wParam:DWORD, lParam:DWORD
    
    ; ??????? ??????? ????? ??? ????????? ?????? ???????????
    invoke CreatePen, PS_SOLID, 1, 0006464FFh  ; RGB(255, 100, 100)
    mov hRedPen, eax
    
    mov eax, 1
    ret
    
InitDialog endp

; ????????? ??????
CommandHandler proc hWnd:DWORD, wParam:DWORD, lParam:DWORD, unused:DWORD
    
    mov eax, wParam
    and eax, 0FFFFh  ; ???????? ??????? ????? (ID ???????)
    
    .if eax == IDCANCEL
        invoke EndDialog, hWnd, 0
    .endif
    
    ret
    
CommandHandler endp

; ??????? ????????? ??????????
PaintHandler proc hWnd:DWORD
    LOCAL ps:PAINTSTRUCT
    LOCAL hdc:DWORD
    LOCAL hOldPen:DWORD
    LOCAL t:real8
    LOCAL x:DWORD
    LOCAL y:DWORD
    LOCAL cosT:real8
    LOCAL sinT:real8
    LOCAL cos2T:real8
    LOCAL sin2T:real8
    LOCAL tempX:real8
    LOCAL tempY:real8
    LOCAL x1:DWORD
    LOCAL y1:DWORD
    LOCAL x2:DWORD
    LOCAL y2:DWORD
    
    ; ???????? ?????????
    invoke BeginPaint, hWnd, addr ps
    mov hdc, eax
    
    ; ?????? ???????????? ???
    ; ?????????????? ???
    invoke MoveToEx, hdc, 0, centerY, NULL
    invoke LineTo, hdc, 180, centerY
    
    ; ???????????? ???  
    invoke MoveToEx, hdc, centerX, 0, NULL
    invoke LineTo, hdc, centerX, 150
    
    ; ?????? ?????? ??????????? (?????? ??????)
    ; ??????????????? ?????????: x = (2*cos(t) - 3*cos(2*t))*15, y = (2*sin(t) - 3*sin(2*t))*15
    finit                        ; ?????????????? FPU
    fldz                        ; ????????? 0 ? ST(0) - ????????? ???????? t
    fstp t
    
    FirstCurveLoop:
        ; ????????? cos(t) ? sin(t)
        fld t
        fcos
        fstp cosT
        
        fld t
        fsin  
        fstp sinT
        
        ; ????????? cos(2*t) ? sin(2*t)
        fld t
        fadd t                   ; 2*t
        fcos
        fstp cos2T
        
        fld t
        fadd t                   ; 2*t
        fsin
        fstp sin2T
        
        ; ????????? x = (2*cos(t) - 3*cos(2*t))*15
        fld two
        fmul cosT               ; 2*cos(t)
        fld three
        fmul cos2T              ; 3*cos(2*t)
        fsubp st(1), st(0)      ; 2*cos(t) - 3*cos(2*t)
        fmul scale              ; ???????? ?? ???????
        fistp tempX
        mov eax, DWORD PTR tempX
        add eax, centerX
        mov x, eax
        
        ; ????????? y = -(2*sin(t) - 3*sin(2*t))*15
        fld two
        fmul sinT               ; 2*sin(t)
        fld three
        fmul sin2T              ; 3*sin(2*t)
        fsubp st(1), st(0)      ; 2*sin(t) - 3*sin(2*t)
        fmul scale              ; ???????? ?? ???????
        fchs                    ; ??????????? ??? ?????????? ??????????
        fistp tempY
        mov eax, DWORD PTR tempY
        add eax, centerY
        mov y, eax
        
        ; ?????? ????? ??? ????????? ?????????????
        mov eax, x
        mov ebx, y
        mov x1, eax
        mov y1, ebx
        add eax, 2
        add ebx, 2
        mov x2, eax
        mov y2, ebx
        invoke Rectangle, hdc, x1, y1, x2, y2
        
        ; ??????????? t ?? ???
        fld t
        fadd step
        fstp t
        
        ; ?????????, ?? ???????? ?? ?? 2*PI
        fld t
        fld PI
        fadd PI                 ; 2*PI
        fcompp
        fstsw ax
        sahf
        jb FirstCurveLoop
    
    ; ????????????? ?? ??????? ????? ??? ?????? ???????????
    invoke SelectObject, hdc, hRedPen
    mov hOldPen, eax
    
    ; ?????? ?????? ??????????? (??????? ??????)
    ; ??????????????? ?????????: x = (2*cos(t) - 1.5*cos(2*t))*15, y = (2*sin(t) - 1.5*sin(2*t))*15
    fldz                        ; ?????????? t ? 0
    fstp t
    
    SecondCurveLoop:
        ; ????????? cos(t) ? sin(t)
        fld t
        fcos
        fstp cosT
        
        fld t
        fsin
        fstp sinT
        
        ; ????????? cos(2*t) ? sin(2*t)
        fld t
        fadd t                   ; 2*t
        fcos
        fstp cos2T
        
        fld t
        fadd t                   ; 2*t
        fsin
        fstp sin2T
        
        ; ????????? x = (2*cos(t) - 1.5*cos(2*t))*15
        fld two
        fmul cosT               ; 2*cos(t)
        fld oneHalf
        fmul cos2T              ; 1.5*cos(2*t)
        fsubp st(1), st(0)      ; 2*cos(t) - 1.5*cos(2*t)
        fmul scale              ; ???????? ?? ???????
        fistp tempX
        mov eax, DWORD PTR tempX
        add eax, centerX
        mov x, eax
        
        ; ????????? y = -(2*sin(t) - 1.5*sin(2*t))*15
        fld two
        fmul sinT               ; 2*sin(t)
        fld oneHalf
        fmul sin2T              ; 1.5*sin(2*t)
        fsubp st(1), st(0)      ; 2*sin(t) - 1.5*sin(2*t)
        fmul scale              ; ???????? ?? ???????
        fchs                    ; ??????????? ??? ?????????? ??????????
        fistp tempY
        mov eax, DWORD PTR tempY
        add eax, centerY
        mov y, eax
        
        ; ?????? ????? ??? ????????? ?????????????
        mov eax, x
        mov ebx, y
        mov x1, eax
        mov y1, ebx
        add eax, 2
        add ebx, 2
        mov x2, eax
        mov y2, ebx
        invoke Rectangle, hdc, x1, y1, x2, y2
        
        ; ??????????? t ?? ???
        fld t
        fadd step
        fstp t
        
        ; ?????????, ?? ???????? ?? ?? 2*PI
        fld t
        fld PI
        fadd PI                 ; 2*PI
        fcompp
        fstsw ax
        sahf
        jb SecondCurveLoop
    
    ; ??????????????? ?????? ?????
    invoke SelectObject, hdc, hOldPen
    
    ; ????????? ?????????
    invoke EndPaint, hWnd, addr ps
    
    ret
    	
PaintHandler endp

end start
